# SOC-Automation-Lab

Acknowledgement: This project benefitted greatly from the tutorial provided by the Youtube Channel [MYDFIR](https://www.youtube.com/@mydfir). MYDFIR's video series on the project were extremly helpful in understanding and implementing the various elements of the SOC Automation Lab project

## 1. Introduction

### 1.1 Overview
This project aims to develop an automated SOC homelab, highly inspired by MyDFIR’s youtube series on the same topic. The full playlist can be found at [SOC Automation Project](https://www.youtube.com/watch?v=XR3eamn8ydQ). In today’s rapidly changing cybersecurity environment, the importance of having a strong Security Operations Center (SOC) has never been greater. As cyber threats grow more advanced, organizations must constantly evolve and improve their detection and response capabilities to protect their assets and data. For aspiring SOC analysts, one method is to build a fully automated SOC homelab to hone their skills in a controlled environment. 

### 1.2 Objectives
- **Hands-on Experience- The primary objective of this project is to provide oneself with hands-on experience in setting up, configuring, and operating a Security Operations Center in a simulated environment.
- **Experience with Tools- By using a range of open-source tools commonly used in real-world SOCs, including Wazuh for alert generation, Shuffle for SOAR (Security Orchestration, Automation, and Response) and TheHive for case management.
- **Incident Response Training- We can simulate various cybersecurity incidents, allowing aspiring analysts to practice incident detection, analysis, and response procedures in a controlled setting.
- **Integration Testing- The project can also teach how to integrate different security tools seamlessly to streamline the incident response process.
- **Threat Intelligence Enrichment- This project incorporates threat intelligence enrichment capabilities, enabling analysts to enrich the Indicator of Compromise (IOCs) through services like VirusTotal. 

## 2. Prerequisites

### 2.1 Infrastructure Requirements
- Virtualization Platform- Use a virtualization platform such as Virtualbox 7.0 or VMWare Workstation 17 Player.
- Cloud Service Provider- Use cloud services such as DigtialOcean, Azure, Google Cloud or AWS for hosting centralized components such as the Wazuh server.

### 2.2 Hardware Requirements
-  A host machine capable of running multiple virtual machines simultaneously.
-  Sufficient CPU (8-24 cores), Memory (32-64GB) and disk space to support the VM's and their expected workloads.

### Components 
- Windows 10 virtual machine: Will serve as the endpoint for telemetry generation using Sysmon
- Wazuh Server: Deployed on a cloud instance to centralize and manage alerts generated by our Win 10 virtual machine
- Wazuh Agent: Installed on the Windows 10 VM to collect the telemetry data and forward it to the Wazuh server.
- Shuffle: Implemented as our SOAR tool to automate response actions based on incoming alerts from Wazuh.
- TheHive: Deployed for centralized case management, enabling analysts to track and respond

## 3. Setup

### 3.1 Step 1: Installation and Configuration of Windows 10 with Sysmon
To begin with, you are going to want create a Windows 10 .iso file. This can be done with the following link: https://www.microsoft.com/en-us/software-download/windows10. Once done, use your choice of virtualization platform to create your windows 10 virtual machine. After your virtual machine has been created, install Sysmon from the official Microsoft sysinternals site and sysmonconfig.xml from the github page [sysmon-modular](https://github.com/olafhartong/sysmon-modular). You’ll want to unzip the downloaded Sysmon file and place the sysmonconfig.xml in the Sysmon file. Then open powershell as administrator and navigate to the Sysmon directory and run the following command: .\sysmon64.exe -i sysmonconfig.xml to start the installation. To verify, you can open the Windows services manager and check for “Sysmon” in services list. 

### 3.2: Step 2: Installing and Configuring Wazuh
For this part, you’ll want to create an account on DigitalOcean. If you’re a student in university, I recommend signing up for Github Education as you’ll will receive $200 in free credits for DigitalOcean which will be more than enough. For my droplet, I went with Ubuntu 22.04 for the OS and $48/mo plan and created an ssh key for sign in purposes. Once done, you’ll need to set up the firewall for the Wazuh server. The inbound rules should allow all TCP/UDP connections to your public ip.   To connect, use either through the droplet console or via ssh through the droplet ip.  
![image](https://github.com/user-attachments/assets/2b905af7-975f-49ee-93aa-85e0bd809b54)

Once created, run apt-get update && apt-get upgrade -y. You’ll be asked about which services to update, but you can skip them. 
To install Wazuh, use the following command: curl -sO https://packages.wazuh.com/4.7/wazuh-install.sh && sudo bash ./wazuh-install.sh -a. If all goes well, you should see the username and password for the wazuh server. Copy it to a safe place, go back into your win10 vm and use the public ip of the wazuh along with the admin account(http://your_droplet_ip). You should be able to login but if you're unable to, use systemctl status wazuh.manager-system to check if wazuh is running.

### 3.2: Step 3: Setting up The Hive
To begin, use the same configuration as the Wazuh server and install TheHive using [Github link](https://github.com/MyDFIR/SOC-Automation-Project). 
Once done, you’ll need to configure Cassandra by editing the configuration file nano /etc/cassandra/cassandra.yaml. You’ll need to set the cluster-name, the listen_address and the rpc_address to the TheHive IP address, and the seed_provider to TheHive public IP. Save the file, stop the service and remove old files in /var/lib/Cassandra/* using rm -rf. Once done, run systemctl start cassandra.service.  
After that, Elasticsearch configuration file by removing hashtags i.e from comment to code. You'll want to uncomment the following:

-cluster.name: Set to thehive
-node.name- this can be node1
-network.host: Set to your server’s public IP
-http.port (optional because by default it’s 9200)

![image](https://github.com/user-attachments/assets/8ba8da77-85fd-4165-852a-a994cb600ed4)

Once done, change owner to thehive user and thehive group over to the intend directories.
![image](https://github.com/user-attachments/assets/c216a202-a8c4-40f4-befd-964ec9bb07b1)

After that, you’ll need to edit the application.conf file by changing host_name to theHive public server ip using nano /etc/thehive/application.conf. Ensure the cluster.name matches what you set in Cassandra.yaml and change the application.baseUrl variable to your public ip. Save and restart the service. 
To access TheHive interface, open a browser and navigate to http://(your_hive_server_ip:9000). If you get an authentication error, check to see if elasticsearch is running. If it’s running, then you’ll need to create a custom jvm file, nano /etc/elasticsearch/jvm.options.d/jvm.options and paste in the following: 
-Dlog4j2.formatMsgNoLookups=true
-Xms2g
-Xmx2g
Save the file and restart the service. 

### 3.2: Step 4: Configuring Wazuh Dashboard
For this part, you’ll want to head to your windows 10 vm, enter the ip address of your wazuh server and login. Select add agents, use the public ip for the server address, create an agent name(optional), and copy the powershell command. Open powershell as admin, paste the command in and press enter. To check, run net start wazuhsvc. 

### 3.2: Step 5: Mimikatz Telemetry Overview into Wazuh & Custom Alert
For this section, first, we want to edit the ossec.conf file on our windows machine by running notepad in admin mode. We are going to delete the application, system, and security configuration from the local file. This implies that only Sysmon will be able to relay events to our Wazuh management. Your ossec file should look like the image below

![image](https://github.com/user-attachments/assets/8d4f75c7-3ded-4845-89cb-90ffdbb20851)

Now we can add an exemption in Windows for our downloads folder so that we can download and extract mimikatz. Run powershell as admin and go into your downloads folder to run the mimikatz application. 

copy the ossec configuration file to the ossec home directory, cp /var/ossec/etc/ossec.conf ~/ossec-backup.conf. Now you can run nano /var/ossec/etc/ossec.conf to edit the file. Once in, change the logall and alerts_log variables to yes, save the file and restart the wazuh-manager.service. Then go to the /var/ossec/logs/archives/ directory and edit the etc/nano/filebeat/filebeat.yml so that the archives variable is set to true. It should look like the image below. 

![image](https://github.com/user-attachments/assets/38336d46-6aaa-40e8-8a83-c6b31179745b)

Once done, go back to the Wazuh dashboard and go to index patterns to create an index for the archives. Return to the dashboard and go to management and select rule, then manage rule files and search Sysmon and select custom rules. Create a custom rule as shown in the image below

![image](https://github.com/user-attachments/assets/867ad619-a5fe-4807-af3b-a9a00d780ed4)

## 3.3 Integrating Shuffle (SOAR)

### 3.3 Part 1
First, register an account on Shuffle’s website and establish a new workflow in the Shuffle Dashboard and name the workflow. Setup the Wazuh integration by including a webhook trigger in the workflow. 
Go back to the wazuh server and modify the ossec.conf configuration file for Wazuh, adding the integration code 
  <integration>
    <name> </name>
    <hook_url>YOUR_WEBHOOK_URL_HERE </hook_url>
    <alert_format>json</alert_format>
    <rule_id>100002</rule_id>
  </integration>
Replace YOUR_SHUFFLE_WEBHOOK_URI with the URI you copied from Shuffle. Restart Wazuh by running  systemctl restart wazuh-manager.

Note: When adding tags, pay attention to the indentation to ensure they align with other lines
The image below shows an example of this 

![image](https://github.com/user-attachments/assets/1149b241-6c7c-42bc-83a8-31e10aff0b3b)

Then rerun Mimikatz on the windows machine. Afterwards, return to Shuffle and start the process 

![image](https://github.com/user-attachments/assets/e55aecc2-ef42-4ee6-b24a-f121c241bdf0)

We click on the person icon below, press Test Workflow. You should be able see the execution and click execution argument.

![image](https://github.com/user-attachments/assets/96cc26f2-71c2-443b-a56e-d682ead047b2)

We should be able to see all the information generated from Wazuh itself. Now what we will extract the SHA hash from the file and check the reputation score on VirusTotal. Since we only want to extract the hash value, we’re going to use regex. 
Click on Change Me and select Regex capture group from the Find Actions menu, then select hashes from the Execution Argument and write regex to the proper field: SHA256=([0–9A-Fa-f]{64})

![image](https://github.com/user-attachments/assets/6bc69e69-3ac0-4360-880a-7670d6171908)

Now Re-run the workflow. 

## Part 2: Enrichment using VirusTotal
First, we’re going to create an account with VirusTotal to get an API key. Copy the API key and return to Shuffle. From Apps, search and select virustotal and drop/drop it to workflow. Under find actions,  select Get a hash report, then click Authenticate VirusTotal V3 and paste your API key. Then select list from Id field 
![image](https://github.com/user-attachments/assets/f6a8da00-9c54-43e3-b59e-a7e827de708d)
![image](https://github.com/user-attachments/assets/d4d27232-7aa1-4f51-b51a-9fcf5a4a7ba9)

Then refresh the workflow and you should be able to see the results. 

![image](https://github.com/user-attachments/assets/59f5d6e3-fa61-4224-a00f-95628e3853d4)

Expand body → attributes → last_analysis_stats and you should be able to see how many scanners have detected the malicious file. 

## 3.4 TheHive Integration

## 3.4 Part 1
Select and activate TheHive  from left menu and connect it to VirusTotal. Then login TheHive using default credentials. After login click + button at the top left corner of the page and create organization. Click to new organization to create users. Click add user and create 2 users; 1 Normal user, 1 Service user then assign password for normal user and create API key for service user. 
Logout from default account and login with the normal user account. 
Go back to Shuffle and Authenticate TheHive using API key we created before, write TheHive address to url field. 

Do the following steps:
    1. Find Actions → Create Alert
    2. Title → $exec.title
    3. Tags → [“T1003”]
    4. Description → Mimikatz detected on host:$exec.text.win.system.computer from user:$exec.text.win.eventdata.user
    5. Summary → Mimikatz activity detection on host: $exec.text.win.system.computer and the process ID:$exec.text.win.system.processID, Command Line: $exec.text.win.eventdata.commandLine
    6. Severity → 2
    7. 7. Flag → false
    8. 8. Pap → 2
    9. 9. Source → Wazuh
    10. 10. Tlp → 2
    11. 11. Sourceref → “Rule: 100002”
    12. 12. Type → Internal
    13. 13. Date → $exec.text.win.eventdata.utcTime
    14. 14. Status → New


Now it’s this point where I ran into a problem where TheHive section would timeout on me and never send the alert to TheHive dashboard as shown below. I was not able to find an answer to this issue so I moved on the final part. 

![image](https://github.com/user-attachments/assets/7f181a77-8f15-4087-9acd-b6e72412f7d3)

## 3.4 Part 2: Sending Email
We will send email to our mailbox about alert Mimikatz Detected. First select email app from left menu and connect it to VirusTotal.
![image](https://github.com/user-attachments/assets/1880de36-793d-4760-bbdb-10686162b2e9)

Then we need to fill in the necessary fields:                             
Body :
$exec.text.win.eventdata.utcTime
Title: $exec.title
Host: $exec.text.win.system.computer
User: $exec.text.win.eventdata.user
Then run workflow
You should receive an email for the alert. 

![image](https://github.com/user-attachments/assets/5eaca868-bf5b-4896-854b-b1d84cb5be6d)
